/*global jQuery */
/*jshint globalstrict: true*/
'use strict';

jQuery.fn.exists = function () {
    return this.length !== 0;
}

var ufal = ufal || {};
var console = window.console || {
        log: function () {
        }
    };

jQuery(document)
    .ready(    		        		
    function () {
    	
    	
        ufal.click_event = ufal.click_event || jQuery.fn.tap ? "tap" : "click";    	    	    	
    	
    	// inform users that cookies are not being used to gather information unnecessarily.
    	if(!ufal.utils.isCookieEqual("cookie-message", "hide")) {
    		var footer = jQuery("<div id='cookie-div' style='z-index: 100; position: fixed; bottom: 0; width: 100%; background-color: #C0C0C0; opacity: 0.9; border-top: 1px solid #C0C0C0; display: none;'>" +
    					"<div class='container' style='padding: 10px; font-weight: bold; color: #333333;'>" +
    						"<div class='col-md-6 col-md-offset-1' style='padding: 2px; font-size: 110%;'>" +    						
    						$.i18n._("autocomplete-cookie-help") +
    						"</div>" +
    						"<div class='col-md-4'>" +
    							"<a id='hide-cookie-div' class='btn btn-default' href='#' style='margin-right: 10px; color: #333333;'><strong>" +
    							$.i18n._("autocomplete-cookie-understand") +
    							"</strong></a>" +
    							"<a class='btn btn-default' style='color: #333333;' href='" + ufal.utils.get_dspace_url() +"page/cookies'><strong>" +
    							$.i18n._("autocomplete-cookie-more-info") +
    							"</strong></a>" +
    						"</div>" +
    					"</div>" +
    				"</div>");
    		jQuery("body").append(footer);
    		jQuery("#cookie-div").slideDown({
    			start: function() {
    				jQuery("#cookie-div").show();
    			}
    		});
    		jQuery("#hide-cookie-div").on(ufal.click_event, function() {
			var date = new Date();
			date.setYear(date.getFullYear() + 1);
    			document.cookie = "cookie-message=hide;expires=" + date.toUTCString() + ";path=" + new URL(ufal.utils.get_dspace_url()).pathname;
    			jQuery("#cookie-div").hide();
    		});
    	}
        
        jQuery("#aspect_eperson_LoginChooser_list_login-options .signon").click();    	

        var downloadLink = ufal.utils.getQueryParameter("download");
        if (downloadLink != null) {
            window.location = decodeURIComponent(downloadLink);
        }

        ufal.utils.handle_side_menu();
        ufal.utils.initialize_layer_slider();
        ufal.utils.handle_broken_images();
        ufal.utils.handle_static_pages_js();
        ufal.utils.basic_functions();
        ufal.utils.handle_modals();
        ufal.utils.convert_codes();

        ufal.search.handle_filters();

        ufal.browse.handle_date_input();

        ufal.utils.replaced_files_and_versions();

        jQuery("[data-toggle='tooltip']").tooltip();

        // I agree button in license agreement should be large
        jQuery(
            "#cz_cuni_mff_ufal_UFALLicenceAgreement_field_confirm_license")
            .addClass("btn btn-large btn-block");

        jQuery('.linkify').each(function (index) {
            ufal.utils.linkify(this);
        });

        jQuery("#cz_cuni_mff_ufal_dspace_app_xmlui_aspect_statistics_GAStatisticsTransformer_field_start_date")
            .datepicker({
                autoclose: true,
                format: 'yyyy-mm-dd',
                forceParse: false
            });

        jQuery("#cz_cuni_mff_ufal_dspace_app_xmlui_aspect_statistics_GAStatisticsTransformer_field_end_date")
            .datepicker({
                autoclose: true,
                format: 'yyyy-mm-dd',
                forceParse: false
            });

        jQuery("#cz_cuni_mff_ufal_dspace_app_xmlui_aspect_statistics_GAStatisticsTransformer_field_update_range")
            .on(ufal.click_event, function () {
                var sDate = jQuery("#cz_cuni_mff_ufal_dspace_app_xmlui_aspect_statistics_GAStatisticsTransformer_field_start_date").attr("value");
                var eDate = jQuery("#cz_cuni_mff_ufal_dspace_app_xmlui_aspect_statistics_GAStatisticsTransformer_field_end_date").attr("value");
                var url = window.location["href"].replace(window.location["search"], "");
                window.location = url + '?start=' + sDate + '&end=' + eDate;
            });

        if (jQuery("#aspect_submission_StepTransformer_field_license").length) {
            jQuery("#aspect_submission_StepTransformer_field_license").select2({
                placeholder: {id: "", text: jQuery("#aspect_submission_StepTransformer_field_license option:selected").text()},
                allowClear: true,
                formatResult: function (license) {
                    var id = license.id;
                    if (id == "") return "<div class='bold' style='padding: 5px;'>" + license.text + "</div>";
                    var a = $("#aspect_submission_StepTransformer_list_license-list li a[name='license_" + id + "']");
                    var label = a.attr("license-label");
                    var label_text = a.attr("license-label-text");
                    return "<div class='bold' style='padding: 5px;'><span class='label label-" + label + "'>" + label + "</span> " + license.text + "</div>";
                },
                formatSelection: function (license) {
                    var id = license.id;
                    if (id == "") return "<div class='bold' style='padding: 5px;'>" + license.text + "</div>";
                    var a = $("#aspect_submission_StepTransformer_list_license-list li a[name='license_" + id + "']");
                    var label = a.attr("license-label");
                    var label_text = a.attr("license-label-text");
                    return "<div class='bold' style='font-size: 120%; padding: 5px;'><span class='label label-" + label + "'>" + label + "</span> " + license.text + "</div>";
                }
            });
        }

        if (jQuery(".licenseselector").length) {

            jQuery("#aspect_submission_StepTransformer_field_license").change(function () {
                jQuery("#aspect_submission_StepTransformer_item_license-not-supported-message").addClass("hidden");
            });

            jQuery(".licenseselector").licenseSelector(
                {
                    licenses: {
                        'pcedt2': {
                            name: 'CC-BY-NC-SA + LDC99T42',
                            available: true,
                            url: 'https://lindat.mff.cuni.cz/repository/xmlui/page/license-pcedt2',
                            description: 'License Agreement for Prague Czech English Dependency Treebank 2.0',
                            categories: ['data', 'by', 'nc', 'sa'],
                        },
                        'cnc': {
                            name: 'Czech National Corpus (Shuffled Corpus Data)',
                            available: true,
                            url: 'https://lindat.mff.cuni.cz/repository/xmlui/page/license-cnc',
                            description: 'License Agreement for the CNC',
                            categories: ['data'],
                        },
                        'hamledt': {
                            name: 'HamleDT 1.0 Licence Agreement',
                            available: true,
                            url: 'https://lindat.mff.cuni.cz/repository/xmlui/page/licence-hamledt',
                            description: 'License Agreement for the HamleDT 1.0',
                            categories: ['data'],
                        },
                        'hamledt-2.0': {
                            name: 'HamleDT 2.0 Licence Agreement',
                            available: true,
                            url: 'https://lindat.mff.cuni.cz/repository/xmlui/page/licence-hamledt-2.0',
                            description: 'HamleDT 2.0 License Agreement',
                            categories: ['data'],
                        },
                        'pdt2': {
                            name: 'PDT 2.0 License',
                            available: true,
                            url: 'https://lindat.mff.cuni.cz/repository/xmlui/page/license-pdt2',
                            description: 'Prague Dependency Treebank, version 2.0 License Agreement',
                            categories: ['data'],
                        },
                        'pdtsl': {
                            name: 'PDTSL',
                            available: true,
                            url: 'https://lindat.mff.cuni.cz/repository/xmlui/page/licence-pdtsl',
                            description: 'Research-Usage License Agreement for the PDTSL',
                            categories: ['data'],
                        },
                        'apache-2': {
                            url: 'http://www.apache.org/licenses/LICENSE-2.0',
                        },
                        'perl-artistic-2': {
                            url: 'http://opensource.org/licenses/Artistic-2.0',
                        },
                        'test-1': {
                            url: 'http://www.google.com',
                        }
                    },
                    onLicenseSelected: function (license) {
                        var selectedLic = license["url"];
                        var allLic = jQuery("#aspect_submission_StepTransformer_list_license-list li a");
                        for (var i = 0; i < allLic.length; i++) {
                            if (allLic[i].href == selectedLic) {
                                var id = allLic[i].name.replace("license_", "");
                                $("#aspect_submission_StepTransformer_field_license").select2("val", id);
                                jQuery('html, body').animate({
                                    scrollTop: $("#aspect_submission_StepTransformer_list_submit-ufal-license").offset().top
                                }, 10);
                                jQuery("#aspect_submission_StepTransformer_item_license-not-supported-message").addClass("hidden");
                                return;
                            }
                        }
                        jQuery("#aspect_submission_StepTransformer_item_license-not-supported-message").removeClass("hidden");
                    }
                }
            );
        }


        if (jQuery("#aspect_administrative_ControlPanel_cell_DEL_COL")) {
            var delCol = jQuery("#aspect_administrative_ControlPanel_cell_DEL_COL");
            jQuery(delCol).append("<input type='checkbox' class='selectall'>");
            jQuery(".selectall").on(ufal.click_event, function () {
                var val = jQuery(this)[0].checked;
                jQuery(".todelete input[type='checkbox']").each(function () {
                    jQuery(this)[0].checked = val;
                });
            });
        }


		
		if(jQuery(".add-service-url")) {
			jQuery(".add-service-url").on(ufal.click_event, function() {
            	var service_div = jQuery(this).parents(".caption")[0];
                var count_input = jQuery("input[name$='_url_count']", service_div)[0];
                var count = parseInt(count_input.value);
                var newRow = jQuery(jQuery("tr", service_div)[count]).clone();
                var input1 = jQuery("input[name$='url_key_" + count + "']", newRow)[0];
                var input2 = jQuery("input[name$='url_value_" + count + "']", newRow)[0];
                input1.name = input1.name.replace(count, count+1);
                input2.name = input2.name.replace(count, count+1);
                input1.value = "";
                input2.value = "";
                newRow.insertAfter(jQuery(jQuery("tr", service_div)[count]));
                count_input.value = count+1;
                return false;
            });					
		}

        jQuery('a[data-href]').each(function(index, anchor){
            anchor = jQuery(anchor);
            anchor.attr('href', anchor.attr('data-href'))
        });

        var clipboard = new Clipboard('.repo-copy-btn');
        clipboard.on('success',   function(e){
              var tooltip = $('<span class="repo-copy-btn-tooltip" style="display: none">Copied!</span>').appendTo($(e.trigger));
              tooltip.fadeIn('slow');
              setTimeout(function () {
                tooltip.fadeOut('slow');
                tooltip.remove();
              }, 1000);
              e.clearSelection();
        });
        jQuery('div#files_section > h4').after(jQuery('<a class="btn btn-primary" href="#" style="text-decoration:none;"><i class="fa fa-download fa-3x" style="display:block;">&nbsp;</i>' + jQuery.i18n._('download-all-cmdline') + '</a>').click(function(e){
            e.preventDefault();
            var jqFilesLinks = $("a.filebutton[href*='bitstream']");
            var baseUrl = jqFilesLinks.prop('href');
            baseUrl = baseUrl.substring(0,baseUrl.lastIndexOf("/"))
            var command = "curl --remote-name-all " + baseUrl + "{";
            jqFilesLinks.each(function(index, element){
                var fileName = $(this).prop('href');
                fileName = fileName.substring(fileName.lastIndexOf("/"));
                command += fileName.split("?")[0];
                if(index < jqFilesLinks.length - 1){
                    command += ',';
                }else{
                    command += '}';
                }
            });
            var jqCommand = jQuery("div#command-div");
            if(jqCommand.length === 0){
                jqCommand = jQuery("<div id='command-div'>")
                    .append(jQuery("<button class=\"repo-copy-btn pull-right\" data-clipboard-target=\"#command-div\" />"))
                    .append(jQuery("<pre style='background-color:#d9edf7; color:#3a87ad;'>").text(command));
                $(this).after(jqCommand);
            }
            jqCommand.fadeToggle();
            //console.log(command);
        }));
	});

//
//
//

ufal.utils = {

    handle_side_menu: function () {

        jQuery("#showhidemenu").on(ufal.click_event, function () {
            jQuery("#main-contents").toggleClass("hidden-xs");
            jQuery("#options-menu").toggleClass("hidden-xs");
            jQuery(".jumbotron").toggleClass("hidden-xs");
        });

        jQuery("#menu-toggler").on(ufal.click_event, function () {
            jQuery("#sidebar").toggleClass("display");
            jQuery(this).toggleClass("display");
            return false;
        });
        var b = jQuery("#sidebar").hasClass("menu-min");
        jQuery("#sidebar-collapse").on(
            ufal.click_event,
            function () {
                jQuery("#sidebar").toggleClass("menu-min");
                jQuery(this).find('[class*="icon-"]:eq(0)').toggleClass(
                    "icon-double-angle-right");
                b = jQuery("#sidebar").hasClass("menu-min");
                if (b) {
                    jQuery(".open > .submenu").removeClass("open");
                }
            });
        var a = "ontouchend" in document;
        jQuery(".nav-list")
            .on(
            ufal.click_event,
            function (g) {
                var f = jQuery(g.target).closest("a");
                if (!f || f.length === 0) {
                    return;
                }
                if (!f.hasClass("dropdown-toggle")) {
                    if (b
                        && ufal.click_event === "tap"
                        && f.get(0).parentNode.parentNode === this) {
                        var h = f.find(".menu-text").get(0);
                        if (g.target !== h
                            && !jQuery.contains(h, g.target)) {
                            return false;
                        }
                    }
                    return;
                }
                var d = f.next().get(0);
                if (!jQuery(d).is(":visible")) {
                    var c = jQuery(d.parentNode).closest("ul");
                    if (b && c.hasClass("nav-list")) {
                        return;
                    }
                    c
                        .find("> .open > .submenu")
                        .each(
                        function () {
                            if (this !== d
                                && !jQuery(
                                    this.parentNode)
                                    .hasClass(
                                    "active")) {
                                jQuery(this).slideUp(
                                    200).parent()
                                    .removeClass(
                                    "open");
                            }
                        });
                }
                if (b
                    && jQuery(d.parentNode.parentNode)
                        .hasClass("nav-list")) {
                    return false;
                }
                jQuery(d).slideToggle(200).parent().toggleClass(
                    "open");
                return false;
            });
    },

    initialize_layer_slider: function () {
        if (jQuery('#layerslider').length > 0) {
            jQuery(".carousel").carousel();
            jQuery(".home-search").focus();
        }
    },

    handle_broken_images: function () {
        jQuery("img[alt!='Icon']").error(function () {
            jQuery(this).css("display", "none");
        });
    },

    handle_static_pages_js: function () {
        jQuery(".helpdesk-tolink").each(function () {
            jQuery(this).attr("href", jQuery(".helpdesk").attr("href"));
        });
    },

    handle_modals: function () {

        if (jQuery('#userbox').length > 0) { // user logged in
            jQuery("#download-all-button").css("visibility", "visible");
        }

    },

    basic_functions: function () {
        //
        jQuery(".hide-parent").each(function () {
            ufal.utils.hide_parent(jQuery(this));
        });
    },

    hide_parent: function (obj) {
        obj.parent().hide();
    },

    linkify: function (obj) {
        var text = jQuery(obj).html();
        var exp = /(\b(https?|ftp|file):\/\/[-A-Z0-9+&@#\/%?=~_|!:,.;]*[-A-Z0-9+&@#\/%=~_|])/ig;
        var emailexp = /([a-z0-9_+.%-]+@[a-z0-9.-]+\.[a-z]{2,6})/gi;
        text = text.replace(exp, "<a target='_blank' href='$1'>$1</a>")
            .replace(emailexp, "<a href='mailto:$1'>$1</a>");
        jQuery(obj).html(text);
    },

    ajax_json: function (url) {
        var data = {};
        jQuery.ajax({
            type: 'GET',
            url: url,
            dataType: 'json',
            success: function () {
            },
            data: {},
            async: false
        }).fail(function (jqXHR, textStatus) {
            console.log("lindat/utils failed to load data: " + textStatus);
        }).done(function (d) {
            data = d;
        });
        if (data == null) {
            console.log("lindat/utils failed to load data: did not get json");
        }
        return data;
    },

    swap_map: function (json) {
        var ret = {};
        for (var key in json) {
            ret[json[key]] = key;
        }
        return ret;
    },

    get_dspace_url: function () {
        var url = document.URL.substr(0, document.URL.search('/xmlui/?'))
            + '/xmlui/';
        return url;
    },

    convert_language_iso_codes: function () {
        var isoFieldsSelectors = '[name="dc_language_iso_selected"] + .ds-interpreted-field, '; //submission
        var numItems = jQuery(isoFieldsSelectors).length;
        if (numItems > 0) {
            var url = ufal.utils.get_dspace_url()
                + 'static/json/iso_langs.json';
            var isoCodesMap = ufal.utils.swap_map(ufal.utils.ajax_json(url));
            jQuery(isoFieldsSelectors).each(function (i) {
                var value = jQuery(this).html();
                var groups = value.match(/^(\s*)(\w{3})(.*)$/);
                if (groups) {
                    var isoCode = groups[2];
                    if (isoCode in isoCodesMap) {
                        value = groups[1] + isoCodesMap[isoCode] + groups[3];
                    }
                }
                jQuery(this).html(value);
            });
        }
    },

    convert_codes: function () {
        ufal.utils.convert_language_iso_codes();
    },

    getQueryParameter: function (str) {
        var queryParams = document.location.search.replace(/(^\?)/, '').split("&").map(function (n) {
            return n = n.split("="), this[n[0]] = n[1], this
        }.bind({}))[0];
        return queryParams[str];
    },

    isCookieExist: function (cname) {
    	var value = ufal.utils.getCookie(cname);
    	if (value != "") {
    		return true;
    	} else {
    		return false;
    	}
    },
    
    isCookieEqual: function (cname, cvalue) {
    	var value = ufal.utils.getCookie(cname);
    	if (value == cvalue) {
    		return true;
    	} else {
    		return false;
    	}
    },
    
    getCookie: function (cname) {
        var name = cname + "=";
        var ca = document.cookie.split(';');
        for(var i = 0; i < ca.length; i++) {
            var c = ca[i];
            while (c.charAt(0) == ' ') {
                c = c.substring(1);
            }
            if (c.indexOf(name) == 0) {
                return c.substring(name.length, c.length);
            }
        }
        return "";    	
    },

    replaced_files_and_versions: function () {
        if (jQuery("#replaced_by_alert").length > 0) {
            jQuery("#files_section").hide();
            jQuery("#replaced_by_alert").parent()
                .after(
                    '<div class="row"><span class="font_smaller col-sm-12" style="margin-top: 1em;" id="show_files_info">' + $.i18n._("autocomplete-original-data-help") + '<a href="#show-files" id="show_files_link">' + $.i18n._('autocomplete-here') + '</a>.</span></div>');
            jQuery("#show_files_link").on('click', function () {
                jQuery("#show_files_info").hide();
                jQuery("#files_section").show();
                jQuery('html, body').delay(100).animate({
                    scrollTop: jQuery("#files_section").offset().top
                }, 200);
            });
        }
        if (jQuery("#view-versions").length > 0) {
            var dropdown = jQuery("#view-versions");
            var list = jQuery("#view-versions ul.dropdown-menu")
            dropdown.on("show.bs.dropdown", function(event){
                var button = dropdown.find("button");
                var hdl = button.attr("data-handle");
                list.toggle();
                if(jQuery("#view-versions ul.dropdown-menu li").length == 0){
                   button.find("img").toggle();
                   var rest_url = ufal.utils.get_dspace_url().replace(/xmlui\/?/, 'rest');
                   jQuery.ajax(rest_url + '/handle/' + hdl)
                   .pipe(
                       function(data){
                           return jQuery.ajax(rest_url + '/items/' + data.id + '/versions');
                       })
                   .pipe(
                       function(data){
                           for(var i=0; i < data.length; i++){
                               var item = data[i];
                               list.append(jQuery("<li>").append(jQuery("<a>").attr("href", "http://hdl.handle.net/" + item.handle).text(item.name).click(function(e){
                                    e.stopPropagation();
                               })));
                           }
                           button.find("img").toggle();
                       })
                   .pipe(null,
                       function(data){
                           console.error(data);
                       });
                }
            });
            dropdown.on("hide.bs.dropdown", function(event){
                list.toggle();
            });
        }
    }
}

//
//
//

ufal.search = {
    handle_filters: function () {
        jQuery(".selected-filter-close-icon")
            .click(
            function () {
                var filter_number = parseInt(jQuery(this).attr("filter_number")) + 1;
                jQuery("input[name='filter_" + filter_number + "'][type='text']")[0].value = "";
                jQuery("#aspect_discovery_SimpleSearch_field_submit_apply_filter").click();
            });

        jQuery(".selected-filter-clearall")
            .click(
            function () {
                jQuery("input[name^='filter_'][type='text']").each(function () {
                    this.value = "";
                });
                jQuery("#aspect_discovery_SimpleSearch_field_submit_apply_filter").click();
            });


        jQuery("select[name^='filter_relational_operator']").change(
            function () {
                var val = jQuery(this).val();
                var tb = jQuery("[name^='filter_'][type='text']", jQuery(this).parent().parent());
                if (val == "notavailable") {
                    tb.css("visibility", "hidden");
                    tb[0].value = "[* TO *]";
                } else {
                    tb[0].value = "";
                    tb.css("visibility", "visible");
                }
            });
    }
};

ufal.browse = {
    handle_date_input: function () {
        jQuery("#aspect_artifactbrowser_ConfigurableBrowse_field_month")
            .change(
            function () {
                jQuery(
                    "#aspect_artifactbrowser_ConfigurableBrowse_field_starts_with")
                    .val("");
            });
        jQuery("#aspect_artifactbrowser_ConfigurableBrowse_field_year")
            .change(
            function () {
                jQuery(
                    "#aspect_artifactbrowser_ConfigurableBrowse_field_starts_with")
                    .val("");
            });
        jQuery("#aspect_artifactbrowser_ConfigurableBrowse_field_starts_with")
            .on(
            'input',
            function () {
                if (jQuery(this).val() != "") {
                    jQuery(
                        "#aspect_artifactbrowser_ConfigurableBrowse_field_month")
                        .val("-1");
                    jQuery(
                        "#aspect_artifactbrowser_ConfigurableBrowse_field_year")
                        .val("-1");
                }
            });

    }
}

window.LindatRefBoxConfig ={
    rest: ufal.utils.get_dspace_url().replace(/xmlui\/?/, 'rest'),
};

